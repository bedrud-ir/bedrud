name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ── Server binaries (multi-platform) ─────────────────────────
  server-binary:
    name: Server – ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux_amd64
            cgo: "1"
            cc: gcc
          - goos: linux
            goarch: arm64
            suffix: linux_arm64
            cgo: "1"
            cc: aarch64-linux-gnu-gcc
          - goos: darwin
            goarch: amd64
            suffix: darwin_amd64
            cgo: "0"
            cc: ""
          - goos: darwin
            goarch: arm64
            suffix: darwin_arm64
            cgo: "0"
            cc: ""
    steps:
      - uses: actions/checkout@v4

      - name: Install cross-compiler
        if: matrix.goarch == 'arm64' && matrix.goos == 'linux'
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: server/go.sum

      # Build frontend
      - name: Build frontend
        working-directory: apps/web
        run: |
          bun install --frozen-lockfile
          bun run build

      # Embed frontend into server
      - name: Embed frontend
        run: |
          rm -rf server/frontend
          mkdir -p server/frontend
          cp -r apps/web/build/* server/frontend/

      # Build server binary
      - name: Build server binary
        working-directory: server
        env:
          CGO_ENABLED: ${{ matrix.cgo }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CC: ${{ matrix.cc }}
        run: |
          go build -ldflags="-s -w" -o ../dist/bedrud ./cmd/bedrud/main.go

      # Package
      - name: Package binary
        run: |
          cd dist
          tar -cJf bedrud_${{ matrix.suffix }}.tar.xz bedrud
          rm bedrud

      - uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.suffix }}
          path: dist/bedrud_${{ matrix.suffix }}.tar.xz

  # ── Docker image ──────────────────────────────────────────────
  docker:
    name: Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── Android APK ──────────────────────────────────────────────
  android:
    name: Android APK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/android
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: gradle/actions/setup-gradle@v4

      # Decode signing key from secrets
      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PROPERTIES: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > keystore.jks
            echo "$KEYSTORE_PROPERTIES" > keystore.properties
          fi

      # Run tests first
      - name: Run unit tests
        run: ./gradlew testDebugUnitTest

      # Build debug APK (always)
      - name: Build debug APK
        run: ./gradlew assembleDebug

      # Build release APK (only if signing key available)
      - name: Build release APK
        run: |
          if [ -f keystore.properties ]; then
            ./gradlew assembleRelease
          else
            echo "⚠ Skipping release build — no signing key configured"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: apps/android/app/build/outputs/apk/debug/app-debug.apk

      - uses: actions/upload-artifact@v4
        if: ${{ hashFiles('apps/android/keystore.properties') != '' }}
        with:
          name: android-release-apk
          path: apps/android/app/build/outputs/apk/release/app-release.apk

  # ── iOS IPA ──────────────────────────────────────────────────
  ios:
    name: iOS IPA
    runs-on: macos-15
    defaults:
      run:
        working-directory: apps/ios
    steps:
      - uses: actions/checkout@v4

      # Import signing certificate and provisioning profile
      - name: Install Apple certificate and provisioning profile
        env:
          P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          if [ -z "$P12_BASE64" ]; then
            echo "⚠ No iOS signing certificate configured — building unsigned archive"
            exit 0
          fi

          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo "$P12_BASE64" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Install provisioning profile
          if [ -n "$PROVISION_PROFILE_BASE64" ]; then
            PP_PATH=$RUNNER_TEMP/profile.mobileprovision
            echo "$PROVISION_PROFILE_BASE64" | base64 --decode > "$PP_PATH"
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/
          fi

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: apps/ios/.spm-cache
          key: ios-spm-${{ hashFiles('apps/ios/Bedrud.xcodeproj/project.pbxproj') }}
          restore-keys: ios-spm-

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Bedrud.xcodeproj \
            -scheme Bedrud \
            -clonedSourcePackagesDirPath .spm-cache

      # Run tests
      - name: Run tests
        run: |
          xcodebuild test \
            -project Bedrud.xcodeproj \
            -scheme Bedrud \
            -destination "platform=iOS Simulator,name=iPhone 16 Pro" \
            -clonedSourcePackagesDirPath .spm-cache \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      # Build archive
      - name: Build archive
        run: |
          xcodebuild archive \
            -project Bedrud.xcodeproj \
            -scheme Bedrud \
            -configuration Release \
            -archivePath build/Bedrud.xcarchive \
            -destination "generic/platform=iOS" \
            -clonedSourcePackagesDirPath .spm-cache \
            CODE_SIGN_STYLE=Automatic \
            -allowProvisioningUpdates

      # Export IPA
      - name: Export IPA
        run: |
          if [ -n "${{ secrets.IOS_P12_BASE64 }}" ]; then
            xcodebuild -exportArchive \
              -archivePath build/Bedrud.xcarchive \
              -exportPath build/export \
              -exportOptionsPlist ExportOptions.plist \
              -allowProvisioningUpdates
          else
            echo "⚠ Skipping IPA export — no signing certificate configured"
          fi

      - uses: actions/upload-artifact@v4
        if: ${{ hashFiles('apps/ios/build/export/Bedrud.ipa') != '' }}
        with:
          name: ios-ipa
          path: apps/ios/build/export/Bedrud.ipa

      # Cleanup keychain
      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi

  # ── GitHub Release ───────────────────────────────────────────
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [server-binary, docker, android, ios]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "{server-*,android-*,web-*,ios-*}"

      - name: Collect release assets
        run: |
          mkdir -p release-assets
          # Server binaries
          find artifacts/server-* -name "*.tar.xz" -exec cp {} release-assets/ \;
          # Android APKs
          [ -f artifacts/android-debug-apk/app-debug.apk ] && \
            cp artifacts/android-debug-apk/app-debug.apk release-assets/bedrud-debug.apk
          [ -f artifacts/android-release-apk/app-release.apk ] && \
            cp artifacts/android-release-apk/app-release.apk release-assets/bedrud-release.apk
          # iOS IPA
          [ -f artifacts/ios-ipa/Bedrud.ipa ] && \
            cp artifacts/ios-ipa/Bedrud.ipa release-assets/Bedrud.ipa
          ls -la release-assets/

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release-assets/*
